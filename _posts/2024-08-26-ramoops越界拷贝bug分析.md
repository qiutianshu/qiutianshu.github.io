---
layout: post
title:  "ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ"
date:   2024-08-26 13:27:38 +0800
category: linux_kernel
---
[æ˜¯è°åœ¨LINUXå†…æ ¸ä¸­å¼€äº†è¿™ä¸ªå¤§æ´ï¼Ÿ](https://mp.weixin.qq.com/s/Sr4qIy-AdLhpkus6q1su9w)


## ä¸€ã€ç¯å¢ƒé…ç½®

### 1. å†…æ ¸ç¯å¢ƒé…ç½®

å†…æ ¸ç‰ˆæœ¬ï¼šLinux-6.1.43

ramoopsçš„å†…æ ¸éƒ¨åˆ†çš„é…ç½®ç”¨äºæŒ‡å®šæ—¥å¿—åœ¨å†…å­˜ä¸­ä¿å­˜çš„ä½ç½®ã€æ—¥å¿—çš„æ€»ç©ºé—´å¤§å°ã€åˆ†é…ç»™ä¸åŒæ—¥å¿—çš„ç©ºé—´ã€ä½¿èƒ½å‘ç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿçš„æ›´æ–°ã€‚

![æˆªå±2024-08-26 09.09.29.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/1.png)

é€šè¿‡å‘grubå¯åŠ¨é…ç½®æ–‡ä»¶ä¸­â€œGRUB_CMDLINE_LINUX_DEFAULTâ€é€‰é¡¹æ·»åŠ å†…æ ¸å¯åŠ¨å‚æ•°å³å¯å®Œæˆé…ç½®ã€‚

è¿™éƒ¨åˆ†é€‰é¡¹å†…å®¹å¯ä»¥å‚è€ƒæ–‡ä»¶â€œfs/pstore/ram.câ€å’Œâ€œfs/pstore/platform.câ€ä¸­å¯¹ramoopsæ¨¡å—å’Œpstoreæ¨¡å—å‚æ•°å®šä¹‰çš„éƒ¨åˆ†

### 2. ç”¨æˆ·ç©ºé—´ç¯å¢ƒé…ç½®

ä¿®æ”¹/etc/systemd/pstore.confçš„â€Unlink=noâ€œï¼Œè¿™ä¸€è¡Œé»˜è®¤æ˜¯è¢«æ³¨é‡Šæ‰çš„ï¼Œéœ€è¦æ‰‹åŠ¨æ‰“å¼€å¹¶ä¸”æŒ‡å®šä¸ºnoï¼Œè¿™ä¸ªå…³ç³»åˆ°æˆ‘ä»¬èƒ½å¦è§¦å‘bugã€‚

![æˆªå±2024-08-26 09.20.34.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/2.png)

## äºŒã€pstore/ramoopsåŠŸèƒ½åˆ†æ

ramoopsæ˜¯ä¼—å¤špstoreåº•å±‚ä»‹è´¨ä¹‹ä¸€ï¼Œç”¨äºåœ¨è®¡ç®—æœºrebootçš„è¿‡ç¨‹ä¸­ä¿å­˜ä¸Šä¸€æ¬¡å¼€æœºè¿è¡Œæ—¶äº§ç”Ÿçš„å†…æ ¸oopsæ—¥å¿—ï¼Œæ‰€ä¾èµ–çš„åº•å±‚åŸç†æ˜¯rebootè¿‡ç¨‹ä¸­å†…å­˜ä¸ä¼šæ–­ç”µï¼Œä¿å­˜åœ¨ç‰¹å®šç‰©ç†å†…å­˜åœ°å€çš„å†…å®¹åœ¨å¼€æœºè¿‡ç¨‹ä¸­å°±å¯ä»¥è¢«é‡æ–°è¯»å–ã€‚

è¿™ä¸ªåŠŸèƒ½ä¸ºå†…æ ¸å¼€å‘è€…æä¾›äº†åœ¨å†…æ ¸å´©æºƒçš„æƒ…å†µä¸‹æŸ¥çœ‹å´©æºƒç°åœºçš„æ‰‹æ®µã€‚

è¯¥åŠŸèƒ½ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š1. ä½äºå†…æ ¸çš„pstore/ramoops  2. ä½äºç”¨æˆ·æ€çš„systemdå’Œsystemd.pstoreæœåŠ¡ã€‚

å‘ç”Ÿoopsçš„æ—¥å¿—ä¿å­˜æµç¨‹ï¼š

![0day-oopsæ‰“å°æµç¨‹.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/3.jpg)

                                                                   

![0day-ç¬¬ 4 é¡µ.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/4.jpg)

æ—¥å¿—çš„æå–å’Œå¯¼å‡ºåˆ°sysæ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹ï¼š

![æˆªå±2024-08-26 10.02.44.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/5.png)

ramoopså°†å›è°ƒå‡½æ•°æ³¨å†Œåˆ°å†…æ ¸æ‰“å°å‡½æ•°ä¸Šï¼Œä¸€æ—¦å‘ç”Ÿoopsä¾¿ä¼šè°ƒç”¨ramoopsåŠŸèƒ½ï¼Œå°†æ—¥å¿—å†™å…¥ç”¨æˆ·æŒ‡å®šçš„ç‰©ç†åœ°å€ï¼ŒåŒæ—¶å°†æ—¥å¿—ä»¥æ–‡ä»¶çš„å½¢å¼å¯¼å‡ºåˆ°/sys/fs/pstoreç›®å½•ä¸‹ã€‚

pstoreæ–‡ä»¶ç³»ç»Ÿçš„å¼€æœºæŒ‚è½½è¿‡ç¨‹ï¼š

![0day-systemdæŒ‚è½½æµç¨‹.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/6.jpg)
                                                     
systemd.pstoreæœåŠ¡çš„é…ç½®è§£æï¼š

![æˆªå±2024-08-26 10.16.17.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/7.png)

systemdåœ¨ç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹ä¸­,æŠŠpstoreæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°/sys/fs/pstoreç›®å½•ä¸‹ã€‚systemd.pstoreæœåŠ¡ç”¨äºå°†/sys/fs/pstoreç›®å½•ä¸‹çš„æ—¥å¿—æ–‡ä»¶è½¬ç§»åˆ°/var/lib/systemd/pstoreç›®å½•ä¸‹å¹¶æŒä¹…åŒ–ã€‚

## ä¸‰ã€å…³é”®çš„å†…æ ¸ç»“æ„ä½“

![0day-ç™½æ¿.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/8.jpg)

## å››ã€æ¼æ´äº§ç”Ÿçš„åŸå› 

![0day.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/9.jpg)

![æˆªå±2024-08-26 10.58.32.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/10.png)

### przâ†’bufferâ†’sizeçš„ä¿®æ”¹è·¯å¾„ï¼š

![0day-ç¬¬ 6 é¡µ.jpg](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/11.jpg)

åœ¨å‘ramoopså†…å­˜åŒºåŸŸå†™å…¥æ—¥å¿—è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆæŠŠprzâ†’bufferâ†’sizeå’Œprzâ†’bufferâ†’startä¸¤ä¸ªå­—æ®µæ¸…é›¶ï¼Œå†æ ¹æ®æ—¥å¿—å†…å®¹é•¿åº¦ï¼Œè°ƒç”¨buffer_size_add()å‡½æ•°é‡æ–°è®¾ç½®sizeå’Œstartå­—æ®µï¼Œå†å‘przâ†’bufferâ†’dataåŒºåŸŸå†™å…¥æ—¥å¿—æ•°æ®ã€‚

### przâ†’bufferâ†’sizeçš„çº¦æŸï¼š

przâ†’bufferâ†’sizeä¸è¶…è¿‡przâ†’buffer_sizeã€‚

![æˆªå±2024-08-26 11.26.58.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/12.png)

przâ†’buffer_sizeç”±sizeå‡å»ç»“æ„ä½“bufferå¤´éƒ¨ç»“æ„çš„å¤§å°ï¼Œè€Œsizeç”±å†…æ ¸å¯åŠ¨å‚æ•°ä¸­çš„ramoops.record_sizeä¼ é€’è¿›æ¥ï¼Œæ‰€ä»¥przâ†’buffer_sizeå¯ä»¥ç”±â€œæ”»å‡»è€…â€æ§åˆ¶ã€‚

è¿›è€Œå¯¼è‡´przâ†’bufferâ†’sizeçš„ä¸Šé™å¯ä»¥ç”±â€œæ”»å‡»è€…â€æ§åˆ¶ã€‚

### æ¼æ´åœºæ™¯ï¼š

step1: å†™ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œè§¦å‘ç©ºæŒ‡é’ˆå¼•ç”¨ï¼Œäº§ç”Ÿä¸€ä¸ªè¾ƒå°çš„oopsæ—¥å¿—ï¼Œrebootï¼›

step2: rebootä¹‹åï¼Œå†…æ ¸åˆ†é…ä¸€ä¸ªè¾ƒå°çš„old_sizeå¯¹è±¡å­˜å‚¨oopsæ—¥å¿—ï¼›

step3: é‡æ–°å†™ä¸€ä¸ªå†…æ ¸æ¨¡å—ï¼Œåœ¨å‡½æ•°åµŒå¥—ä¸­è§¦å‘ç©ºæŒ‡é’ˆå¼•ç”¨ï¼Œäº§ç”Ÿä¸€ä¸ªè¾ƒå¤§çš„oopsæ—¥å¿—ï¼›

step4: åœ¨å®šæ—¶å™¨çš„ä½œç”¨ä¸‹ï¼Œå†…æ ¸æŒ‰ç…§500msçš„æ—¶é—´é—´éš”è§¦å‘æ¼æ´å‡½æ•°ï¼Œå°†è¾ƒå¤§çš„oopsæ—¥å¿—å†™å…¥ä¹‹å‰çš„old_logå¯¹è±¡ä¸­ï¼Œè§¦å‘è¶Šç•Œå†™ã€‚

## äº”ã€æ¼æ´è°ƒè¯•è¿‡ç¨‹

æ–­ç‚¹ï¼š

```jsx
b ram.c:385.           #breakpoint 32  æ£€æŸ¥ç¬¬äºŒæ¬¡æ—¥å¿—çš„é•¿åº¦æ˜¯å¦å¤§äºold_log_size
```

![æˆªå±2024-08-23 13.18.47.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/13.png)

ç¡®è®¤ç¬¬äºŒæ¬¡çš„æ—¥å¿—é•¿åº¦å¤§äºold_log_sizeï¼Œcç»§ç»­è¿è¡Œï¼Œè®©å®šæ—¶å™¨å›è°ƒå‡½æ•°è°ƒç”¨æ¼æ´å‡½æ•°

ctrl+cï¼Œå›è¿‡å¤´æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦å‘ç”Ÿæº¢å‡º

### systemdé€‰é¡¹unlink=noçš„ä½œç”¨

åœ¨å‰æœŸè°ƒè¯•è¿‡ç¨‹ä¸­å‘ç°ï¼Œåœ¨æ–­ç‚¹å¤„old_logè¢«é‡Šæ”¾æ‰äº†ï¼Œå¯¼è‡´przâ†’old_log=0ï¼Œold_log_size=0ã€‚

![æˆªå±2024-08-26 13.00.01.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/14.png)

old_logå¯¹è±¡ç”±persistent_ram_free_old()å‡½æ•°é‡Šæ”¾ï¼Œå¯¹è¯¥å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå¹¶ä¸”æ ˆå›æº¯ï¼Œå‘ç°ç”±ç”¨æˆ·æ€è°ƒç”¨è¿‡æ¥çš„ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°ramoops_pstore_eraseå‡½æ•°ï¼Œè¯¥å‡½æ•°çš„ä½œç”¨æ˜¯æ¸…é™¤æ—§çš„æ—¥å¿—ï¼Œç¬é—´è”æƒ³åˆ°systemd.pstoreé…ç½®æ–‡ä»¶ä¸­unlinké€‰é¡¹çš„ä½œç”¨ï¼Œå°†æ—¥å¿—ä»/sysç›®å½•æ¬åˆ°/varä¹‹åæ¸…é™¤/sysç›®å½•ä¸‹çš„å†…å®¹ã€‚å› æ­¤è®¾ç½®unlink=noå°±å¯ä»¥é¿å…è¿›å…¥é‡Šæ”¾old_logçš„è·¯å¾„ã€‚

![æˆªå±2024-08-26 13.03.21.png](/assets/posts/2024-08-26-ramoopsè¶Šç•Œæ‹·è´bugåˆ†æ/15.png)

## å…­ã€æ¼æ´å¯åˆ©ç”¨æ€§åˆ†æ

| éœ€è¦rootæƒé™ | âœ… |
| --- | --- |
| æ”»å‡»è€…æ§åˆ¶å †å—å†…å®¹ | â“ğŸ¤” |
| å †å–·å°„ï¼Ÿ | ğŸ˜­ğŸ˜­ |
| æ”»å‡»è€…ç²¾å‡†æ§åˆ¶è¦†ç›–æŒ‡é’ˆ | ğŸ˜­ğŸ˜­ğŸ˜­ |

## ä¸ƒã€è¡¥ä¸å»ºè®®

```c
void persistent_ram_save_old(struct persistent_ram_zone *prz)
{
		struct persistent_ram_buffer *buffer = prz->buffer;
		size_t size = buffer_size(prz);
		size_t start = buffer_start(prz);

		if (!size)
				return;
				
++  if(size > prz->old_log_size && prz->old_log_size != 0 && prz->old_log != NULL){
++		  persistent_ram_ecc_old(prz);              //æ›´æ–°ecc info
++			kfree(prz->old_log);                      //é‡Šæ”¾æ‰æ—§çš„old_log
++		  prz->old_log = kmalloc(size, GFP_KERNEL); //åˆ†é…æ–°çš„old_log
++	}

		if (!prz->old_log) {
				persistent_ram_ecc_old(prz);
				prz->old_log = kmalloc(size, GFP_KERNEL);
		}
			
		if (!prz->old_log) {
				pr_err("failed to allocate buffer\n");
				return;
		}

		prz->old_log_size = size;                    //æ›´æ–°old_log_size
		memcpy_fromio(prz->old_log, &buffer->data[start], size - start);
		memcpy_fromio(prz->old_log + size - start, &buffer->data[0], start);
}
```