<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="http://localhost:4000/assets/fonts/fonts.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/style.css"/>
<link rel="stylesheet" href="http://localhost:4000/assets/js/lity.min.css"/>



<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta property="og:site_name" content="极目楚天舒" />
<meta 
    property="og:title"
    content="
        
            蓝牙sco条件竞争漏洞挖掘与分析
        
    " 
/>

<meta property="og:url" content="http://localhost:4000//linux_kernel/2025/01/18/%E8%93%9D%E7%89%99sco%E9%A9%B1%E5%8A%A8%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98.html" />

    <meta property="og:type" content="article" />



    <meta property="fb:app_id" content="" />



<title>
    
        蓝牙sco条件竞争漏洞挖掘与分析
    
</title>
</head>
<body class="index">
    
        <div class="page-container">
            <aside class="main-sidebar">
                <!-- 包含 TOC -->
                <sidebar class="sidebar">
<ul class="toc-list"><li><a href="#一环境搭建">一、环境搭建</a></li><li><a href="#二发现过程">二、发现过程</a><ul><li><a href="#1-条件假设">1. 条件假设</a></li><li><a href="#2-漏洞原理">2. 漏洞原理</a></li><li><a href="#3-攻击效果">3. 攻击效果</a></li></ul></li><li><a href="#三漏洞历史">三、漏洞历史</a><ul><li><a href="#2024年11月15日">2024年11月15日</a></li><li><a href="#2024年10月23日">2024年10月23日</a></li><li><a href="#2024年5月4日">2024年5月4日</a></li><li><a href="#2023年4月11日">2023年4月11日</a></li><li><a href="#2022年5月13日">2022年5月13日</a></li></ul></li><li><a href="#四时间线">四、时间线</a></li><li><a href="#五漏洞验证">五、漏洞验证</a></li></ul></sidebar>
            </aside>
            <!-- 主内容区域 -->
            <main class="main-content">
                <header class="header">
    <section class="logo">
        <a href="http://localhost:4000/" class="logo__link">
            
                <h1>极目楚天舒</h1>
            
        </a>
    </section>
    
    <button id="menuToggle">
        <div></div>
        <div></div>
        <div></div>
    </button>
    <nav class="menu">
        
<ul class="list primary">

    
        <li class="item">

            <div class="item-controls">
                <a href="http://localhost:4000/category/linux_kernel.html">
                
                    <img src="http://localhost:4000/assets/img/icons/tux.png"/>
                
                
                    <p style="color: var(--c-themeHueRed)">Linux kernel</p>
                
                </a>

            
            </div>
            
        </li>   
    
        <li class="item">

            <div class="item-controls">
                <a href="http://localhost:4000/category/linux_userspace.html">
                
                    <img src="http://localhost:4000/assets/img/icons/userspace.png"/>
                
                
                    <p style="color: var(--c-themeHueRed)">Linux userspace</p>
                
                </a>

            
            </div>
            
        </li>   
    
        <li class="item">

            <div class="item-controls">
                <a href="http://localhost:4000/category/hardware.html">
                
                    <img src="http://localhost:4000/assets/img/icons/chip.svg"/>
                
                
                    <p style="color: var(--c-themeHueRed)">Hardware</p>
                
                </a>

            
            </div>
            
        </li>   
    
        <li class="item">

            <div class="item-controls">
                <a href="http://localhost:4000/category/meltdown_spectre.html">
                
                    <img src="http://localhost:4000/assets/img/icons/meltdown_spectre.png"/>
                
                
                    <p style="color: var(--c-themeHueRed)">Side Channel</p>
                
                </a>

            
            </div>
            
        </li>   
    
        <li class="item">

            <div class="item-controls">
                <a href="http://localhost:4000/category/riscv.html">
                
                    <img src="http://localhost:4000/assets/img/icons/riscv.png"/>
                
                
                    <p style="color: var(--c-themeHueRed)">Riscv</p>
                
                </a>

            
            </div>
            
        </li>   
    
</ul>
    </nav>
</header>
                
                <article class="post">

    <div class="post__title">
       蓝牙sco条件竞争漏洞挖掘与分析
    </div>
    <div class="post__meta"> 
        <div class="post__meta__category">
            
                <p class="post__meta__category__title" style="background: var(--c-themeHueBlue)">Linux内核漏洞</p>
            
        </div>
        <p class="post__meta__divider">·</p>
        <div class="post__meta__date">
            January 18, 2025
        </div>
        
    </div>

    
    <div class="post__content">
        <p>2023年使用syzkaller对Linux内核进行fuzz的过程中，发现了蓝牙协议栈sco子协议的条件竞争漏洞，2024年11月8日，在审计Linux内核网络协议栈中锁的使用的过程中，通过相似性分析的方法，再次发现了一个sco的条件竞争漏洞。</p>

<h2 id="一环境搭建">一、环境搭建</h2>

<p>发行版本Ubuntu24.04，内核版本Linux 6.11.5，打开KASAN、DEBUG_INFO、BT选项编译</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/1.png" alt="截屏2024-11-22 10.01.31.png" /></p>

<p>需要注意的是，vmware fusion 13.6往后的版本不支持蓝牙，所以我把版本降低到vmware fusion 13.5.2，该版本是唯一免费的个人使用版本。</p>

<p>USB兼容性设置为2.0，共享主机蓝牙，这样Ubuntu里面可以识别到主机蓝牙。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/2.png" alt="截屏2024-11-11 11.12.04.png" /></p>

<p>对于Linux 5.17开始的内核会出现hciconfig hci0 up命令失败的情况，原因是Linux蓝牙驱动和虚拟机连接的主机蓝牙芯片不匹配。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/WechatIMG427.jpg" alt="WechatIMG427.jpg" /></p>

<p>根本原因在于hci_cc_func函数中新加入了对数据包长度的校验。</p>

<p>若事件是HCI_OP_DELETE_STORED_LINK_KEY，那么通过查表得cc→min_len = 3，而skb→len = 2</p>

<p>此处校验就过不去。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/3.png" alt="截屏2024-11-11 11.18.07.png" /></p>

<p>解决的方法是，在函数hci_cmd_complete_evt函数中判断</p>

<p>如果是HCI_OP_DELETE_STORED_LINK_KEY操作，那么直接返回*status=0，并在前面做必要的处理，这样就绕过了hci_cc_func函数。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/4.png" alt="截屏2024-11-11 11.19.49.png" /></p>

<h2 id="二发现过程">二、发现过程</h2>

<h3 id="1-条件假设">1. 条件假设</h3>

<p>我在net目录中查找对内核套接字struct sock对象的未上锁访问时发现了这个bug。</p>

<p>我认为struct sock是在多个线程之间共享的。访问struct sock对象，特别是读写sk-&gt;sk_state，应提前调用lock_sock进行上锁，并在最后一次访问struct sock对象后调用release_sock进行解锁以防止线程之间的竞争。</p>

<p>现实依据是，我观察了多个网络协议的实现均是用这种方式保护struct sock的并发访问，例如tipc、can、蓝牙hci协议、packet、虚拟机套接字vmw_vsock等协议的实现。</p>

<p>CVE-2023-32606、CVE-2021-3609、CVE-2021-26708、CVE-2016-8655都是在读写struct sock对象的时候没有进行加锁保护导致的条件竞争。</p>

<p>其原理简单粗暴，以tipc协议的连接操作为例，使用lock_sock从一开始就把struct sock对象的操作保护起来，防止多线程并发访问的不同步导致状态机紊乱。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/5.png" alt="截屏2024-11-22 10.15.03.png" /></p>

<h3 id="2-漏洞原理">2. 漏洞原理</h3>

<p>条件竞争漏洞发生在sco_sock_connect函数中，该函数被lock_sock分割为3个临界区。</p>

<p>一开始判断全局对象sk的状态这部分逻辑没有进行上锁保护，这一点很可疑。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/6.png" alt="截屏2024-11-22 10.43.48.png" /></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/7.png" alt="截屏2024-11-22 10.46.22.png" /></p>

<p>如果同时来了两个connect调用，都通过了sk对象状态检查，开始竞争第一个临界区的锁，线程1首先创建一个sco_conn对象，并且sco_pi(sk)→conn指向sco_conn。</p>

<p>线程2创建第二个sco_conn对象，再次设置sco_pi(sk)→conn指向sco_conn，如此一来线程1创建的sco_conn就被悬空，再无指针可以引用它。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/8.png" alt="截屏2024-11-22 11.04.27.png" /></p>

<p>对象关系：</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/9.jpg" alt="socket-timer-第 5 页.jpg" /></p>

<p>悬空过程调用链条：sco_sock_connect -&gt; sco_connect -&gt; sco_chan_add -&gt; __sco_chan_add</p>

<p>UAF触发过程：</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/10.png" alt="截屏2024-11-22 11.33.54.png" /></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/11.png" alt="截屏2024-11-22 12.47.26.png" /></p>

<h3 id="3-攻击效果">3. 攻击效果</h3>

<p>受影响版本：linux-6.3.0 ～ linux-6.11.5</p>

<p>攻击效果：控制流劫持、本地权限提升</p>

<h2 id="三漏洞历史">三、漏洞历史</h2>

<p>该漏洞最早出现在2022年5月13日之前，中间被短暂地修补，因第一次修补后性能问题进行了第二次修补，漏洞被重新引入。</p>

<p>随后进行的第三次和第四次修补遏制了条件竞争发生之后的UAF，其中第三次修补的是另一个条件竞争漏洞与这次发现的关系不大，第四次修补遏制了UAF但是却没有解决条件竞争引发的sco_conn对象悬空问题。</p>

<p>第五次修补解决了悬空sco_conn对象的释放，解决了内存泄漏的问题。</p>

<h3 id="2024年11月15日">2024年11月15日</h3>

<p>这是最新的一次提交，在struct sco_conn对象内部嵌入了内核对象计数器kref用于跟踪sco_conn对象的生命周期，及时释放掉不再被引用的对象。</p>

<p><a href="https://github.com/torvalds/linux/commit/e6720779ae612a14ac4ba7fe4fd5b27d900d932c">https://github.com/torvalds/linux/commit/e6720779ae612a14ac4ba7fe4fd5b27d900d932c</a></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/12.png" alt="截屏2024-11-22 13.16.10.png" /></p>

<p>嵌入kerf对象：</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/13.png" alt="截屏2024-11-23 10.13.16.png" /></p>

<p>悬空sco_conn被释放的逻辑：</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/14.png" alt="截屏2024-11-23 10.05.05.png" /></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/15.png" alt="截屏2024-11-23 10.17.00.png" /></p>

<h3 id="2024年10月23日">2024年10月23日</h3>

<p>该提交解决了在sco_sock_connect发生条件竞争的情况下，阻止后续UAF的产生。</p>

<p><a href="https://github.com/torvalds/linux/commit/1bf4470a3939c678fb822073e9ea77a0560bc6bb">https://github.com/torvalds/linux/commit/1bf4470a3939c678fb822073e9ea77a0560bc6bb</a></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/16.png" alt="截屏2024-11-22 13.19.32.png" /></p>

<p>方法是在异步线程中，访问sock对象之前检查sock对象是否还在sco_sk_list链表中，因为在close的时候sock对象会被从sco_sk_list移除。</p>

<p>但它并没有解决悬空sco_conn对象的问题，这又会产生内存泄漏的问题，因为没有任何指针可以引用到sco_conn对象。</p>

<h3 id="2024年5月4日">2024年5月4日</h3>

<p>该提交解决了一个sco_sock_timeout函数中的UAF漏洞，并申请了漏洞编号CVE-2024-27398。</p>

<p><a href="https://github.com/torvalds/linux/commit/483bc08181827fc475643272ffb69c533007e546">https://github.com/torvalds/linux/commit/483bc08181827fc475643272ffb69c533007e546</a></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/17.png" alt="截屏2024-11-22 13.15.37.png" /></p>

<p>该漏洞产生于close系统调用和定时器函数sco_sock_timeout之间的竞争，并不是本次发现的sco_sock_connect之间的条件竞争。</p>

<h3 id="2023年4月11日">2023年4月11日</h3>

<p>该提交目的是为了修补一个潜在的死锁：</p>

<p><a href="https://github.com/torvalds/linux/commit/9a8ec9e8ebb5a7c0cfbce2d6b4a6b67b2b78e8f3">https://github.com/torvalds/linux/commit/9a8ec9e8ebb5a7c0cfbce2d6b4a6b67b2b78e8f3</a></p>

<p>2022年5月份的修补使用lock_sock()全程保护sco_sock_connect在某些情况下会造成死锁，新的提交对sco_sock_connect分成3段分别加锁，企图通过尽可能缩小lock_sock()的作用范围来避免死锁。</p>

<p>本次发现的漏洞也产生于这个提交。</p>

<p>但这又使得sock对象状态机的判断逻辑脱离了lock_sock()的保护，重新引入了条件竞争漏洞，被修补好的漏洞又出现了。</p>

<h3 id="2022年5月13日">2022年5月13日</h3>

<p>该漏洞早在2022年5月13日已经得到了修补：</p>

<p><a href="https://github.com/torvalds/linux/commit/7aa1e7d15f8a5b65f67bacb100d8fc033b21efa2">https://github.com/torvalds/linux/commit/7aa1e7d15f8a5b65f67bacb100d8fc033b21efa2</a></p>

<p>当时有研究人员使用syzkaller打出了这个内核崩溃，同样也是两个并发的connect之后产生了一个悬空的sco_conn对象，close掉文件句柄之后在定时器函数sco_sock_timeout中触发了UAF。</p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/18.png" alt="截屏2024-11-22 10.48.47.png" /></p>

<p>该修补使用lock_sock()完整的保护了sco_sock_connect函数中整个连接过程，将sock对象状态机的判断和修改完整的置于锁保护之中，消除了sco_sock_connect函数的并发访问，从根源上避免了sco_conn悬空对象的产生。但由此产生了一些性能的问题，进而有了2023年4月份的修补。</p>

<p>我使用syzkaller在2023年1月份也打出了这个漏洞，当时和王宇轩等人进行过分析，开发出了漏洞利用代码。</p>

<h2 id="四时间线">四、时间线</h2>

<p>2024年11月8日，发现漏洞；</p>

<p>2024年11月13日，写出PoC；</p>

<p>2024年11月14日，向security@kernel.org 和 linux-distros@vs.openwall.org 发送漏洞报告；</p>

<p>2024年11月15日，补丁被打上，提交编号为<a href="https://github.com/torvalds/linux/commit/e6720779ae612a14ac4ba7fe4fd5b27d900d932c">e672077</a>；</p>

<h2 id="五漏洞验证">五、漏洞验证</h2>

<p><a href="https://github.com/qiutianshu/sco-race-condition">https://github.com/qiutianshu/sco-race-condition</a></p>

<p><img src="/assets/posts/2025-01-18-蓝牙sco驱动条件竞争漏洞挖掘/19.png" alt="截屏2024-11-23 10.34.30.png" /></p>

    </div>
</article>

                
                <footer class="footer">
        <section class="footer__about">
                <p class="footer__about__copyright">© qts588 2025</p>
                
                <span class="divider">·</span>
                
                <span class="footer__about__theme"><p>theme</p><a id="simplex-logo" href="https://github.com/andreondra/jekyll-theme-simplex" target="_blank"><img alt="Simplex theme logo" src="http://localhost:4000/assets/img/icons/simplex_logo.svg"/></a><p>by <a href="https://ondrej.golasowski.com/">golas</a></p></span>
        </section>
</footer>

                <script src="http://localhost:4000/assets/js/jquery.slim.min.js"></script>
<script src="http://localhost:4000/assets/js/lity.min.js"></script>
<script src="http://localhost:4000/assets/js/tools.js"></script>
<script src="http://localhost:4000/assets/js/pic.js"></script>
<script src="http://localhost:4000/assets/js/toc-highlight.js"></script>
            </main>
        </div>
    
</body>
</html>